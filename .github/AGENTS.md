
# 智能体（Agents）指南

> 目的：为在本仓库（Berry）中自动化或半自动化执行任务的智能体提供统一、可审计、安全且高效的工作规范。

## 一、适用范围

本指南适用于所有以编程/自动化方式在仓库中执行更改的智能体（包括但不限于代码补丁、测试运行、文档更新、构建与发布脚本）。人类协作者也应参考本文件以理解智能体的行为约束。

## 二、智能体职责与能力

- 明确目标：在修改代码或配置前，应理解目标（issue/任务）与预期行为。
- 小步提交：变更应小而可回滚，单次 PR 聚焦一件事并包含说明、测试及回归考虑。
- 可复现验证：提交前必须能在本地/CI 上完成构建与基本测试（见“验证”一节）。
- 安全与隐私：不得在仓库中写入任何明文凭证、私钥或敏感信息。发现需要凭证的任务时，创建文档说明并提示使用 CI secret 或 .env 占位符。

## 三、工作流与交互规范

1. 任务接收
	 - 智能体应从明确的 issue、任务或 PR 描述开始工作；若任务不明确，应在 issue 中留下问题并暂停自动更改。
2. 本地开发分支
	 - 使用短生命周期分支，命名规则建议：agent/<agent-name>-<短描述>（例如 `agent/auto-fix-typo`）。
3. 变更原则
	 - 单一责任：每个 PR 只解决一个问题（功能/修复/文档/测试）。
	 - 提交信息：采用简洁说明 + 关联 Issue（如有）。示例："Fix: 修复 X 模块空引用异常 (#123)"。
4. 代码审查
	 - 自动创建 PR 后应等待人工或其他自动化审查通过再合并，除非获得明确的免审策略授权。

## 四、允许与禁止的操作

- 允许：代码更改（通过 `apply_patch`/PR）、添加/更新测试、更新文档、生成样例、构建与运行测试。
- 禁止：在代码库中提交任何明文秘密（API key、密码、私钥）；直接在主分支强制合并未经审查的更改；修改 CI 凭证配置（应由仓库管理员手动处理）。

## 五、代码质量与风格

- 遵循现有项目风格：仓库中主要为 .NET (C#)、前端 (TypeScript/Vite) 项目，请遵守对应的格式化工具（dotnet format、prettier、eslint 等）。
- 单元测试：新增功能或修复应附带单元/集成测试（当可行）。
- 静态检查：优先通过现有的静态分析与编译器警告修复明显问题。

## 六、构建与验证（最低验证要求）

在提交变更前，智能体应至少执行：

- 后端 (.NET)
	- dotnet restore
	- dotnet build --configuration Release
	- dotnet test （针对改动相关的 test 项）

- 前端 (front/)
	- npm ci
	- npm run build

如果变更影响 CI 配置、Dockerfile 或发布脚本，应在 PR 描述中明确潜在风险并请求人工审核。

示例（PowerShell）：

```powershell
dotnet restore
dotnet build -c Release
dotnet test
npm ci --prefix front
npm run build --prefix front
```

## 七、提交与 PR 模板要点

- 说明变更目的、范围与不可回避的副作用。
- 列出验证步骤（复现命令、测试用例）。
- 若变更包含迁移、数据库脚本或对外契约变更，明确回滚策略。

## 八、分支与合并策略

- 主分支保护：`main`/`master` 与 `release` 分支为保护分支，需通过 CI 与审查后才能合并。
- 智能体默认不直接合并到受保护分支；由人工或具有合并权限的自动化流程执行最终合并。

## 九、权限与工具使用说明

- 智能体可以使用仓库内工具（脚本、makefile、dotnet CLI、npm）来构建与测试。
- 对于需要外部网络请求或云资源的操作，优先使用模拟/本地替代；确需真实凭证时创建 Issue 并由人类同事配置 CI secret。

## 十、错误处理与回滚

- 若变更导致构建/测试失败或引入回归，智能体应：
	1. 立即在 PR/Issue 中记录失败细节与回滚建议；
	2. 如能自动回滚（回退提交），在得到授权后创建回滚 PR 并标注紧急（`hotfix`）。

## 十一、审计与可追踪性

- 每个自动变更必须记录来源（agent 名称/版本）、时间戳与关联 issue/PR 编号，便于审计。
- 变更记录应写入 PR 描述与 commit message 中。

## 十二、示例场景与操作示例

- 修复后端单元测试失败：
	1. 在 `agent/` 分支上修复并运行 `dotnet test`；
	2. 创建 PR，描述变更并包含本地验证的测试输出；
	3. 等待审查合并。

- 更新前端样式或构建脚本：
	1. 在本地运行 `npm run build --prefix front` 确保 build 成功；
	2. 在 PR 中说明兼容性影响并附带构建产物检查要点。

## 十三、仓库特有注意事项

- 本仓库包含多个子项目：
	- `src/`：主要 .NET 项目与模块（如 `Berry.Host`, `Berry.Modules.*`）
	- `front/`：前端界面（Vite + TypeScript）
	- `samples/`, `demos/`：示例与演示项目

智能体在修改模块内部行为（例如 VectorStore、Embeddings 等）时，应特别注意向后兼容与文档更新。

## 十四、附录：常用命令速查

- 恢复/构建/测试（根目录）：

```powershell
dotnet restore
dotnet build -c Release
dotnet test
```

- 前端构建（`front/`）：

```powershell
npm ci --prefix front
npm run build --prefix front
```

## 结束语

遵循本指南可以让智能体在本仓库内安全、高效、可审计地工作。若需在权限或工作流上例外处理，请在 issue 中提出并经项目维护者批准。

---
_文档生成：由维护者与智能体协作维护，最后更新时间请写在 PR 描述中。_
